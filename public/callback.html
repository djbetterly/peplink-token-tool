<!doctype html>
<html>
<head>
  <title>Peplink OAuth Callback</title>
  <style>
    body {
      background: #000;
      color: #FFCC00;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h2, h3 {
      color: #FFCC00;
    }
    .section {
      margin-bottom: 20px;
    }
    .result-section {
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid #ffcc00;
      border-radius: 8px;
      background: #1a1a1a;
    }
    .device {
      margin: 6px 0 6px 20px;
      padding: 6px;
      border: 1px solid #333;
      background: #000;
      color: #fff;
      border-radius: 4px;
    }
    label {
      font-weight: bold;
      color: #FFCC00;
    }
    input {
      background: #222;
      color: #fff;
      border: 1px solid #FFCC00;
      padding: 6px;
      border-radius: 4px;
      width: 400px;
    }
    button {
      background: #FFCC00;
      color: #000;
      border: none;
      padding: 8px 12px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
      margin-right: 8px;
    }
    button:hover {
      background: #ffe066;
    }
    .copy-btn {
      margin-left: 10px;
      padding: 3px 8px;
      font-size: 0.85em;
      background: #ffcc00;
      color: #000;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>Peplink OAuth Information</h2>

<div id="token-section" class="section">
  <div><strong>Exchanging code for token...</strong></div>
</div>

<div id="org-section" class="section" style="display:none;">
  <h3>Organizations & Devices</h3>
  <div id="org-container"></div>
  <button id="send-to-esp">Send to ESP</button>
</div>

<script>
  let accessToken = "";
  let refreshToken = "";

  function copyButton(text) {
    const btn = document.createElement('button');
    btn.textContent = 'Copy';
    btn.className = 'copy-btn';
    btn.onclick = async () => {
      await navigator.clipboard.writeText(text);
      btn.textContent = 'Copied!';
      setTimeout(() => btn.textContent = 'Copy', 1200);
    };
    return btn;
  }

  async function exchangeCodeForToken(code, clientId, clientSecret, redirectUri) {
    const res = await fetch('https://api.ic.peplink.com/api/oauth2/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        grant_type: 'authorization_code',
        code: code,
        client_id: clientId,
        client_secret: clientSecret,
        redirect_uri: redirectUri
      })
    });

    return res.ok ? await res.json() : null;
  }

  async function fetchOrgsAndDevices(token) {
    const container = document.getElementById('org-container');
    container.innerHTML = "";

    const orgRes = await fetch('https://api.ic.peplink.com/api/my/organizations', {
      headers: { Authorization: `Bearer ${token}` }
    });
    const orgs = await orgRes.json();

    for (const org of orgs.data || []) {
      const orgDiv = document.createElement('div');
      orgDiv.className = 'result-section';

      const orgName = document.createElement('div');
      orgName.innerHTML = `<strong>Org:</strong> ${org.name}`;
      orgDiv.appendChild(orgName);

      const orgId = document.createElement('div');
      orgId.innerHTML = `Organization ID: ${org.id}`;
      orgId.appendChild(copyButton(org.id));
      orgDiv.appendChild(orgId);

      // Fetch groups
      const groupRes = await fetch(`https://api.ic.peplink.com/api/organizations/${org.id}/groups`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const groups = await groupRes.json();

      for (const group of groups.data || []) {
        const groupName = document.createElement('div');
        groupName.innerHTML = `Group Name: ${group.name}`;
        orgDiv.appendChild(groupName);

        const groupId = document.createElement('div');
        groupId.innerHTML = `Group ID: ${group.id}`;
        groupId.appendChild(copyButton(group.id));
        orgDiv.appendChild(groupId);

        // Fetch devices
        const deviceRes = await fetch(`https://api.ic.peplink.com/api/groups/${group.id}/devices`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        const devices = await deviceRes.json();

        for (const device of devices.data || []) {
          const devDiv = document.createElement('div');
          devDiv.className = 'device';
          devDiv.innerHTML = `<strong>${device.name}</strong><br>Device ID: ${device.id}`;
          devDiv.appendChild(copyButton(device.id));
          orgDiv.appendChild(devDiv);
        }
      }

      container.appendChild(orgDiv);
    }
  }

  // Send token back to ESP
  document.getElementById('send-to-esp').addEventListener('click', async () => {
    const espUrl = "/auth_peplink";
    const payload = { access_token: accessToken, refresh_token: refreshToken };

    const res = await fetch(espUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    alert(res.ok ? "✅ Tokens sent to ESP!" : "❌ Failed to send to ESP.");
  });

  // Main flow
  (async () => {
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");
    const state = params.get("state");

    if (!code || !state) {
      document.getElementById("token-section").innerHTML = "<strong>Missing code or state in URL.</strong>";
      return;
    }

    try {
      const decodedState = JSON.parse(atob(decodeURIComponent(state)));
      const clientId = decodedState.client_id;
      const clientSecret = decodedState.client_secret;
      const redirectUri = "https://peplink.logic-box.co/callback.html";

      const tokenData = await exchangeCodeForToken(code, clientId, clientSecret, redirectUri);

      if (!tokenData || !tokenData.access_token) {
        document.getElementById("token-section").innerHTML = "<strong>Token exchange failed.</strong>";
        return;
      }

      accessToken = tokenData.access_token;
      refreshToken = tokenData.refresh_token;

      // Display token info
      const section = document.getElementById("token-section");
      section.innerHTML = "";
      const div = document.createElement("div");
      div.className = "result-section";

      const at = document.createElement("div");
      at.textContent = `Access Token: ${accessToken}`;
      at.appendChild(copyButton(accessToken));
      div.appendChild(at);

      const rt = document.createElement("div");
      rt.textContent = `Refresh Token: ${refreshToken}`;
      rt.appendChild(copyButton(refreshToken));
      div.appendChild(rt);

      div.appendChild(document.createElement("hr"));
      section.appendChild(div);

      // Load orgs/devices
      document.getElementById("org-section").style.display = "block";
      await fetchOrgsAndDevices(accessToken);

    } catch (err) {
      console.error(err);
      document.getElementById("token-section").innerHTML = "<strong>Error parsing response.</strong>";
    }
  })();
</script>

</body>
</html>
