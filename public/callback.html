<!DOCTYPE html>
<html>
<head>
  <title>Peplink OAuth Callback</title>
  <style>
    body {
      background: #000;
      color: #FFCC00;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h2, h3 {
      color: #FFCC00;
    }
    .result-section {
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid #FFCC00;
      border-radius: 8px;
      background: #1a1a1a;
    }
    .group, .device {
      margin-left: 20px;
    }
    button {
      background: #FFCC00;
      color: #000;
      border: none;
      padding: 8px 12px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
      margin-top: 10px;
      margin-right: 10px;
    }
    button:hover {
      background: #ffe066;
    }
  </style>
</head>
<body>
  <h2>Peplink OAuth Callback</h2>
  <div id="result" class="result-section">Waiting for token exchange...</div>
  <button id="fetch-orgs" style="display:none;">Fetch Orgs & Devices</button>
  <button id="send-to-esp" style="display:none;">Send to ESP</button>

  <h3>Organization Data:</h3>
  <div id="orgs-container"></div>

  <script>
    const code = new URLSearchParams(window.location.search).get('code');
    const redirectUri = 'https://peplink.logic-box.co/callback.html';

    // Replace these with actual or stored client ID/secret if needed
    const clientId = localStorage.getItem('peplink_client_id') || '';
    const clientSecret = localStorage.getItem('peplink_client_secret') || '';

    let accessToken = '';
    let refreshToken = '';

    async function exchangeCodeForToken() {
      if (!code || !clientId || !clientSecret) {
        document.getElementById('result').innerHTML = `
          <b>Error:</b> Missing code, client_id, or client_secret.<br>
          <br>
          <b>code:</b> ${code}<br>
          <b>client_id:</b> ${clientId}<br>
          <b>client_secret:</b> ${clientSecret ? '••••••••••••' : '(missing)'}
        `;
        return;
      }

      const res = await fetch('https://api.ic.peplink.com/api/oauth2/token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          client_id: clientId,
          client_secret: clientSecret,
          code,
          redirect_uri: redirectUri,
          grant_type: 'authorization_code'
        })
      });

      const data = await res.json();
      const resultDiv = document.getElementById('result');

      if (data.access_token) {
        accessToken = data.access_token;
        refreshToken = data.refresh_token;

        resultDiv.innerHTML = `
          <div><strong>Access Token:</strong> ${accessToken}</div>
          <div><strong>Refresh Token:</strong> ${refreshToken}</div>
        `;

        document.getElementById('fetch-orgs').style.display = 'inline-block';
        document.getElementById('send-to-esp').style.display = 'inline-block';
      } else {
        resultDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
      }
    }

    async function fetchOrganizationsAndDevices() {
      const container = document.getElementById('orgs-container');
      container.innerHTML = '';

      const orgRes = await fetch('https://api.ic.peplink.com/api/rest/o/organizations', {
        headers: { Authorization: `Bearer ${accessToken}` }
      });
      const orgData = await orgRes.json();

      for (const org of orgData.data || []) {
        const orgDiv = document.createElement('div');
        orgDiv.className = 'result-section';
        orgDiv.innerHTML = `<strong>Organization:</strong> ${org.name} (ID: ${org.id})`;

        // Fetch groups
        const groupRes = await fetch(`https://api.ic.peplink.com/api/rest/o/${org.id}/groups`, {
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        const groupData = await groupRes.json();

        for (const group of groupData.data || []) {
          const groupDiv = document.createElement('div');
          groupDiv.className = 'group';
          groupDiv.innerHTML = `<strong>Group:</strong> ${group.name} (ID: ${group.id})`;

          // Fetch devices
          const deviceRes = await fetch(`https://api.ic.peplink.com/api/rest/o/${org.id}/groups/${group.id}/devices`, {
            headers: { Authorization: `Bearer ${accessToken}` }
          });
          const deviceData = await deviceRes.json();

          for (const device of deviceData.data || []) {
            const deviceDiv = document.createElement('div');
            deviceDiv.className = 'device';
            deviceDiv.textContent = `Device: ${device.name} (ID: ${device.id})`;
            groupDiv.appendChild(deviceDiv);
          }

          orgDiv.appendChild(groupDiv);
        }

        container.appendChild(orgDiv);
      }
    }

    async function sendTokensToESP() {
      const res = await fetch('/save_tokens', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          access_token: accessToken,
          refresh_token: refreshToken
        })
      });

      if (res.ok) {
        alert('✅ Tokens sent to ESP.');
      } else {
        alert('❌ Failed to send tokens.');
      }
    }

    document.getElementById('fetch-orgs').addEventListener('click', fetchOrganizationsAndDevices);
    document.getElementById('send-to-esp').addEventListener('click', sendTokensToESP);

    exchangeCodeForToken(); // Run immediately if code is present
  </script>
</body>
</html>
