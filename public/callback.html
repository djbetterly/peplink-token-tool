<!doctype html>
<html>
<head>
  <title>Peplink OAuth Code Exchange</title>
  <style>
    body {
      background: #000;
      color: #FFCC00;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h2, h3 {
      color: #FFCC00;
    }
    .result-section {
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid #ffcc00;
      border-radius: 8px;
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .device {
      margin: 8px 0 8px 20px;
      padding: 6px;
      border: 1px solid #333;
      background: #000;
      color: #fff;
      border-radius: 4px;
    }
    .copy-btn {
      margin-left: 10px;
      padding: 4px 10px;
      font-size: 0.85em;
      background: #ffcc00;
      color: #000;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .copy-btn:hover {
      background: #e6b800;
    }
    label {
      font-weight: bold;
      color: #FFCC00;
    }
    input {
      background: #222;
      color: #fff;
      border: 1px solid #FFCC00;
      padding: 6px;
      border-radius: 4px;
      width: 400px;
    }
    button {
      background: #FFCC00;
      color: #000;
      border: none;
      padding: 8px 12px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
      margin-right: 8px;
    }
    button:hover {
      background: #ffe066;
    }
    a {
      color: #FFCC00;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h2>Exchange OAuth Code for Token</h2>
  <form id="exchange-form" class="section">
    <label>Code:</label><br>
    <input id="code"><br><br>
    <label>Client ID:</label><br>
    <input id="client_id"><br><br>
    <label>Client Secret:</label><br>
    <input id="client_secret"><br><br>
    <label>Redirect URI:</label><br>
    <input id="redirect_uri" value="https://peplink.logic-box.co/callback.html"><br><br>
    <button type="submit">Fetch Token</button>
  </form>

  <h3>Token Response:</h3>
  <div id="result"></div>
  <button id="fetch-ids" style="display:none;">Fetch Organizations & Devices</button>
  <button id="export-btn" style="display:none;">Export All Info</button>
  <button id="copy-tokens" style="display:none;">Copy Tokens</button>

  <h3>Organization Data:</h3>
  <div id="ids-result"></div>

  <script>
    // Global variables
    var lastAccessToken = null;
    var allData = { tokens: {}, orgs: [] };
    var firstOrgId = null, firstGroupId = null, firstDeviceId = null;

    // Initialize on page load
    window.addEventListener('load', function() {
      initializePage();
    });

    function initializePage() {
      console.log("ðŸ”§ Initializing page...");
      
      var urlParams = new URLSearchParams(window.location.search);
      var code = urlParams.get('code');
      var state = urlParams.get('state');
      
      if (code && document.getElementById('code')) {
        document.getElementById('code').value = code;
      }

      // Handle state parameter
      var storedClientId = localStorage.getItem('peplink_client_id') || '';
      var storedClientSecret = localStorage.getItem('peplink_client_secret') || '';

      if (state) {
        try {
          var decoded = atob(decodeURIComponent(state));
          var parsed = JSON.parse(decoded);
          console.log("ðŸ” Parsed state parameter:", parsed);
          if (parsed.client_id) {
            storedClientId = parsed.client_id;
            console.log("âœ… Client ID from state:", storedClientId.substring(0, 8) + "...");
          }
          if (parsed.client_secret) {
            storedClientSecret = parsed.client_secret;
            console.log("âœ… Client Secret from state:", storedClientSecret.substring(0, 8) + "...");
          }
        } catch (e) {
          console.error('Failed to parse state param:', e);
        }
      }

      console.log("ðŸ”§ Setting form values:");
      console.log("  Client ID:", storedClientId.substring(0, 8) + "...");
      console.log("  Client Secret:", storedClientSecret.substring(0, 8) + "...");

      if (document.getElementById('client_id')) {
        document.getElementById('client_id').value = storedClientId;
        console.log("âœ… Client ID field set");
      }
      if (document.getElementById('client_secret')) {
        document.getElementById('client_secret').value = storedClientSecret;
        console.log("âœ… Client Secret field set");
      }
      if (document.getElementById('redirect_uri')) {
        document.getElementById('redirect_uri').value = localStorage.getItem('peplink_redirect_uri') || 'https://peplink.logic-box.co/callback.html';
      }

      // Set up form listener
      var form = document.getElementById('exchange-form');
      if (form) {
        form.addEventListener('submit', handleFormSubmit);
      }
    }

    function createCopyButton(text) {
      var btn = document.createElement('button');
      btn.textContent = 'Copy';
      btn.className = 'copy-btn';
      btn.onclick = function(e) {
        e.preventDefault();
        copyToClipboard(text, btn);
      };
      return btn;
    }

    function copyToClipboard(text, button) {
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(function() {
          button.textContent = 'Copied!';
          setTimeout(function() { button.textContent = 'Copy'; }, 1500);
        }).catch(function() {
          fallbackCopy(text);
        });
      } else {
        fallbackCopy(text);
      }
    }

    function fallbackCopy(text) {
      prompt('Copy this text:', text);
    }

    function createDeviceDiv(device) {
      var div = document.createElement('div');
      div.className = 'device';
      var name = document.createElement('div');
      name.textContent = 'Device Name: ' + device.name;
      var id = document.createElement('div');
      id.textContent = 'Device ID: ' + device.id;
      id.appendChild(createCopyButton(device.id));
      div.appendChild(name);
      div.appendChild(id);
      return div;
    }

    function handleFormSubmit(e) {
      e.preventDefault();
      console.log("ðŸ”„ Form submitted");
      
      var body = {
        code: document.getElementById('code').value,
        client_id: document.getElementById('client_id').value,
        client_secret: document.getElementById('client_secret').value,
        redirect_uri: document.getElementById('redirect_uri').value
      };

      localStorage.setItem('peplink_client_id', body.client_id);
      localStorage.setItem('peplink_client_secret', body.client_secret);
      localStorage.setItem('peplink_redirect_uri', body.redirect_uri);

      fetch('/api/exchange-code', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      })
      .then(function(res) { return res.json(); })
      .then(function(json) {
        var container = document.getElementById('result');
        container.innerHTML = '';

        if (json.access_token) {
          lastAccessToken = json.access_token;
          allData.tokens = json;
          
          // Show buttons
          document.getElementById('fetch-ids').style.display = 'inline-block';
          document.getElementById('export-btn').style.display = 'inline-block';
          document.getElementById('copy-tokens').style.display = 'inline-block';
          
          // Set up button listeners
          setupButtonListeners();

          var div = document.createElement('div');
          div.className = 'result-section';

          var accessRow = document.createElement('div');
          accessRow.textContent = 'Access Token: ' + json.access_token;
          accessRow.appendChild(createCopyButton(json.access_token));

          var refreshRow = document.createElement('div');
          refreshRow.textContent = 'Refresh Token: ' + json.refresh_token;
          refreshRow.appendChild(createCopyButton(json.refresh_token));

          var typeRow = document.createElement('div');
          typeRow.textContent = 'Token Type: ' + json.token_type;

          var expiresRow = document.createElement('div');
          expiresRow.textContent = 'Expires In: ' + json.expires_in + ' seconds';

          div.appendChild(accessRow);
          div.appendChild(refreshRow);
          div.appendChild(typeRow);
          div.appendChild(expiresRow);
          container.appendChild(div);
        } else {
          container.textContent = JSON.stringify(json, null, 2);
        }
      })
      .catch(function(error) {
        console.error('Error:', error);
      });
    }

    function setupButtonListeners() {
      console.log("ðŸ”§ Setting up button listeners");
      
      // Fetch IDs button
      var fetchBtn = document.getElementById('fetch-ids');
      if (fetchBtn) {
        fetchBtn.onclick = function() {
          handleFetchIds();
        };
      }
      
      // Copy tokens button
      var copyTokensBtn = document.getElementById('copy-tokens');
      if (copyTokensBtn) {
        copyTokensBtn.onclick = function() {
          handleCopyTokens();
        };
      }
      
      // Copy payload button
      var copyPayloadBtn = document.getElementById('copy-payload');
      if (copyPayloadBtn) {
        copyPayloadBtn.onclick = function() {
          handleCopyPayload();
        };
      }
    }

    function handleFetchIds() {
      console.log("ðŸ”„ Fetching organization data");
      
      if (!lastAccessToken) {
        alert('No access token available.');
        return;
      }

      fetch('/api/list-orgs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ access_token: lastAccessToken })
      })
      .then(function(res) { return res.json(); })
      .then(function(json) {
        var container = document.getElementById('ids-result');
        container.innerHTML = '';
        allData.orgs = [];

        if (json.data && Array.isArray(json.data)) {
          processOrganizations(json.data, container);
        }
      })
      .catch(function(error) {
        console.error('Error fetching orgs:', error);
      });
    }

    function processOrganizations(orgs, container) {
      var processed = 0;
      
      orgs.forEach(function(org, index) {
        if (!firstOrgId) firstOrgId = org.id;

        var div = document.createElement('div');
        div.className = 'result-section';

        // Fetch groups for this org
        fetch('/api/list-groups', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ access_token: lastAccessToken, org_id: org.id })
        })
        .then(function(res) { return res.json(); })
        .then(function(groupsJson) {
          var group = null;
          if (groupsJson.data && groupsJson.data.length > 0) {
            group = groupsJson.data[0];
            if (!firstGroupId) firstGroupId = group.id;
          }

          var orgName = document.createElement('div');
          orgName.textContent = 'Organization Name: ' + org.name;
          div.appendChild(orgName);

          if (group) {
            var groupName = document.createElement('div');
            groupName.textContent = 'Group Name: ' + group.name;
            div.appendChild(groupName);
          }

          var sep1 = document.createElement('div');
          sep1.textContent = '--';
          div.appendChild(sep1);

          var orgId = document.createElement('div');
          orgId.textContent = 'Organization ID: ' + org.id;
          orgId.appendChild(createCopyButton(org.id));
          div.appendChild(orgId);

          if (group) {
            var groupId = document.createElement('div');
            groupId.textContent = 'Group ID: ' + group.id;
            groupId.appendChild(createCopyButton(group.id));
            div.appendChild(groupId);
          }

          var sep2 = document.createElement('div');
          sep2.textContent = '--';
          div.appendChild(sep2);

          var status = document.createElement('div');
          status.textContent = 'Status: ' + org.status;
          div.appendChild(status);

          var link = document.createElement('div');
          link.innerHTML = '<a href="' + org.url + '" target="_blank">View in InControl</a>';
          div.appendChild(link);

          // Fetch devices
          return fetch('/api/list-devices', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ access_token: lastAccessToken, org_id: org.id })
          });
        })
        .then(function(res) { return res.json(); })
        .then(function(devicesJson) {
          var devices = [];
          if (devicesJson.data && Array.isArray(devicesJson.data)) {
            devicesJson.data.forEach(function(device) {
              devices.push({ id: device.id, name: device.name });
              div.appendChild(createDeviceDiv(device));
              if (!firstDeviceId) firstDeviceId = device.id;
            });
          }

          allData.orgs.push({ org: org, group: group, devices: devices });
          container.appendChild(div);
        })
        .catch(function(error) {
          console.error('Error processing org:', error);
        });
      });
    }

    function handleCopyTokens() {
      console.log("ðŸ”„ Copy Tokens button clicked");
      
      if (!allData.tokens.access_token || !allData.tokens.refresh_token) {
        alert("No token data available. Please fetch tokens first.");
        return;
      }

      var tokenData = {
        accessToken: allData.tokens.access_token,
        refreshToken: allData.tokens.refresh_token,
        clientID: document.getElementById('client_id').value,
        clientSecret: document.getElementById('client_secret').value,
        redirectURI: document.getElementById('redirect_uri').value,
        orgID: firstOrgId || "",
        groupID: firstGroupId || "",
        deviceID: firstDeviceId || ""
      };

      var tokenString = JSON.stringify(tokenData, null, 2);
      console.log("ðŸ“¦ Token data to copy:", tokenString);
      
      if (navigator.clipboard) {
        navigator.clipboard.writeText(tokenString).then(function() {
          alert('ðŸ”‘ Token data copied to clipboard!\n\nNow go to your ESP utilities page and click the "ðŸ“‹ Paste Tokens" button.');
        }).catch(function(error) {
          console.error('Copy failed:', error);
          fallbackCopy(tokenString);
        });
      } else {
        fallbackCopy(tokenString);
      }
    }
  </script>
</body>
</html>
